<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue2源码之响应式及队列调度 | 星辰小站</title>
    <meta name="description" content="A VitePress site">
    <meta name="generator" content="VitePress v1.6.3">
    <link rel="preload stylesheet" href="/vitePress/assets/style.DveMpVUb.css" as="style">
    <link rel="preload stylesheet" href="/vitePress/vp-icons.css" as="style">
    
    <script type="module" src="/vitePress/assets/app.Cot2AtnT.js"></script>
    <link rel="preload" href="/vitePress/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/vitePress/assets/chunks/theme.wJ7Ueiqu.js">
    <link rel="modulepreload" href="/vitePress/assets/chunks/framework.CtsLwA2Q.js">
    <link rel="modulepreload" href="/vitePress/assets/front_source_vue2_reactive_index.md.BdwNWjlU.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-b282b196><!--[--><!--]--><!--[--><span tabindex="-1" data-v-45d8b977></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-45d8b977>Skip to content</a><!--]--><!----><header class="VPNav" data-v-b282b196 data-v-82703ed6><div class="VPNavBar" data-v-82703ed6 data-v-2cb5bc40><div class="wrapper" data-v-2cb5bc40><div class="container" data-v-2cb5bc40><div class="title" data-v-2cb5bc40><div class="VPNavBarTitle has-sidebar" data-v-2cb5bc40 data-v-8ad40d82><a class="title" href="/vitePress/" data-v-8ad40d82><!--[--><!--]--><!----><span data-v-8ad40d82>星辰小站</span><!--[--><!--]--></a></div></div><div class="content" data-v-2cb5bc40><div class="content-body" data-v-2cb5bc40><!--[--><!--]--><div class="VPNavBarSearch search" data-v-2cb5bc40><!----></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-2cb5bc40 data-v-5469ab6f><span id="main-nav-aria-label" class="visually-hidden" data-v-5469ab6f> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/vitePress/" tabindex="0" data-v-5469ab6f data-v-f214b409><!--[--><span data-v-f214b409>首页</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/vitePress/meinv/hufu.html" tabindex="0" data-v-5469ab6f data-v-f214b409><!--[--><span data-v-f214b409>宝宝</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/vitePress/Markdown.html" tabindex="0" data-v-5469ab6f data-v-f214b409><!--[--><span data-v-f214b409>Markdown</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/vitePress/api/label.html" tabindex="0" data-v-5469ab6f data-v-f214b409><!--[--><span data-v-f214b409>演示</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/vitePress/component.html" tabindex="0" data-v-5469ab6f data-v-f214b409><!--[--><span data-v-f214b409>SwyUI 组件库</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/vitePress/component.html" tabindex="0" data-v-5469ab6f data-v-f214b409><!--[--><span data-v-f214b409>TocoUI 组件库</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink active" href="/vitePress/front/engi/rule.html" tabindex="0" data-v-5469ab6f data-v-f214b409><!--[--><span data-v-f214b409>前端</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/vitePress/javascript.html" tabindex="0" data-v-5469ab6f data-v-f214b409><!--[--><span data-v-f214b409>javascript</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/vitePress/back/framework/chooseFrameWork.html" tabindex="0" data-v-5469ab6f data-v-f214b409><!--[--><span data-v-f214b409>后端</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/vitePress/others/operation/git.html" tabindex="0" data-v-5469ab6f data-v-f214b409><!--[--><span data-v-f214b409>其他</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/vitePress/conventionalCommits/git.html" tabindex="0" data-v-5469ab6f data-v-f214b409><!--[--><span data-v-f214b409>Git 规范</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/vitePress/python/basic.html" tabindex="0" data-v-5469ab6f data-v-f214b409><!--[--><span data-v-f214b409>python</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/vitePress/AILargeModel/TechnicalTerm.html" tabindex="0" data-v-5469ab6f data-v-f214b409><!--[--><span data-v-f214b409>大模型</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-2cb5bc40 data-v-26feee45><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-26feee45 data-v-1e75da64 data-v-cce0a53d><span class="check" data-v-cce0a53d><span class="icon" data-v-cce0a53d><!--[--><span class="vpi-sun sun" data-v-1e75da64></span><span class="vpi-moon moon" data-v-1e75da64></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-2cb5bc40 data-v-2ae02655 data-v-a37d668f><!--[--><a class="VPSocialLink no-icon" href="https://github.com/vuejs/" aria-label="github" target="_blank" rel="noopener" data-v-a37d668f data-v-f653fc27><span class="vpi-social-github"></span></a><a class="VPSocialLink no-icon" href="https://twitter.com/vuejs" aria-label="twitter" target="_blank" rel="noopener" data-v-a37d668f data-v-f653fc27><span class="vpi-social-twitter"></span></a><a class="VPSocialLink no-icon" href="https://discord.com/invite/vue" aria-label="discord" target="_blank" rel="noopener" data-v-a37d668f data-v-f653fc27><span class="vpi-social-discord"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-2cb5bc40 data-v-5e7ca9a0 data-v-1c0f8d8a><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-1c0f8d8a><span class="vpi-more-horizontal icon" data-v-1c0f8d8a></span></button><div class="menu" data-v-1c0f8d8a><div class="VPMenu" data-v-1c0f8d8a data-v-1fd6d94e><!----><!--[--><!--[--><!----><div class="group" data-v-5e7ca9a0><div class="item appearance" data-v-5e7ca9a0><p class="label" data-v-5e7ca9a0>Appearance</p><div class="appearance-action" data-v-5e7ca9a0><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-5e7ca9a0 data-v-1e75da64 data-v-cce0a53d><span class="check" data-v-cce0a53d><span class="icon" data-v-cce0a53d><!--[--><span class="vpi-sun sun" data-v-1e75da64></span><span class="vpi-moon moon" data-v-1e75da64></span><!--]--></span></span></button></div></div></div><div class="group" data-v-5e7ca9a0><div class="item social-links" data-v-5e7ca9a0><div class="VPSocialLinks social-links-list" data-v-5e7ca9a0 data-v-a37d668f><!--[--><a class="VPSocialLink no-icon" href="https://github.com/vuejs/" aria-label="github" target="_blank" rel="noopener" data-v-a37d668f data-v-f653fc27><span class="vpi-social-github"></span></a><a class="VPSocialLink no-icon" href="https://twitter.com/vuejs" aria-label="twitter" target="_blank" rel="noopener" data-v-a37d668f data-v-f653fc27><span class="vpi-social-twitter"></span></a><a class="VPSocialLink no-icon" href="https://discord.com/invite/vue" aria-label="discord" target="_blank" rel="noopener" data-v-a37d668f data-v-f653fc27><span class="vpi-social-discord"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-2cb5bc40 data-v-71662641><span class="container" data-v-71662641><span class="top" data-v-71662641></span><span class="middle" data-v-71662641></span><span class="bottom" data-v-71662641></span></span></button></div></div></div></div><div class="divider" data-v-2cb5bc40><div class="divider-line" data-v-2cb5bc40></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-b282b196 data-v-1d79227c><div class="container" data-v-1d79227c><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-1d79227c><span class="vpi-align-left menu-icon" data-v-1d79227c></span><span class="menu-text" data-v-1d79227c>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-1d79227c data-v-02a2f15b><button data-v-02a2f15b>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-b282b196 data-v-ea6bbdaf><div class="curtain" data-v-ea6bbdaf></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-ea6bbdaf><span class="visually-hidden" id="sidebar-aria-label" data-v-ea6bbdaf> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-21a3c426><section class="VPSidebarItem level-0 collapsible" data-v-21a3c426 data-v-ce46bc99><div class="item" role="button" tabindex="0" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><h2 class="text" data-v-ce46bc99>前端面试题</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-ce46bc99><span class="vpi-chevron-right caret-icon" data-v-ce46bc99></span></div></div><div class="items" data-v-ce46bc99><!--[--><section class="VPSidebarItem level-1 collapsible" data-v-ce46bc99 data-v-ce46bc99><div class="item" role="button" tabindex="0" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><h3 class="text" data-v-ce46bc99>HTML5与CSS3</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-ce46bc99><span class="vpi-chevron-right caret-icon" data-v-ce46bc99></span></div></div><div class="items" data-v-ce46bc99><!--[--><div class="VPSidebarItem level-2 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/html5/newFeatures.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>HTML5 新特性</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/css3/newFeatures.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>CSS3 新特性</p><!--]--></a><!----></div><!----></div><!--]--></div></section><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/layout-method.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>CSS布局方式</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/div-center.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>DIV居中</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/pseudo-class.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>伪类与伪元素的区别</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/css-priority.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>css 选择器的优先级排序</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/copy.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>深拷贝与浅拷贝</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/encapsulated.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>封装过的组件</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/jsonp.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>JSONP原理</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/Local-offline-storage.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>本地离线存储</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/link.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>LINK与A标签</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/box-model.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>盒子模型</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/closure.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>闭包</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/scope.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>作用域</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/website-performance.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>网站性能优化</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/es6.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>ES5 与 ES6新特性</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/mvvm.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>对于MVVM的理解</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/life-cycle.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>Vue生命周期</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/two-way-binding.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>Vue数据双向绑定</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/component-value-transfer.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>组件间传值</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/route.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>Vue路由</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/route-hook-function.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>Vue路由钩子函数</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/vuex.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>Vue数据管理中心</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/keep-alive.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>keep-alive</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/style-isolation.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>css样式隔离</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/v-ifANDv-show.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>v-if 和 v-show</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/vue-route-vs-router.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>vue-route 和 vue-router</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/vue-core-concepts.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>vue核心概念</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/v-for-v-if.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>v-for 和 v-if</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/vue-modifiers.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>Vue修饰符</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/cross-domain.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>vue中的跨域问题</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/browser-server-interaction.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>浏览器与服务器的交互原理</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/v-on.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>v-on 可以绑定多个方法吗</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/key.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>vue中key 值的作用</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/nextTick.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>$nextTick的使用</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/method.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>父组件调用子组件方法</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/page-flashing.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>项目初始化页面闪动问题</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/vue2-vue3.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>vue2 与vue3 的区别</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/vue-react.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>vue和react的区别</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/arrary.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>js数组的方法</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/DOM-tree.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>监听 DOM 树</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/event-cycle-mechanism.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>JavaScript 的事件循环机制</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/data-type.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>Javascript的数据类型</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/typeof.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>怎样判断变量的类型</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/transfer-type.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>数据类型转换</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/prototypeand-prototype-chain.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>原型和原型链</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/call-apply-bind.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>call /apply /bind</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/event-stream.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>DOM 事件流和事件委托详解</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/new-operator.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>new 操作符内部原理详解</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/Anti-vibration-throttling.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>防抖、节流的应用场景</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/this.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>this指向</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/let-const.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>let const var 的区别</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/promiss.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>Promise 的理解</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/promiss-lian.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>Promise 为什么支持链式调用</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/javascript-yunxingjizhi.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>Javascript的运行机制</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/extends.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>实现继承的几种方式</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/lese.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>浏览器垃圾回收</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/kaifa-chongtu.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>多人开发 避免版本冲突</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/interview/git-changyong.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>Git 常用命令</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-21a3c426><section class="VPSidebarItem level-0 collapsible" data-v-21a3c426 data-v-ce46bc99><div class="item" role="button" tabindex="0" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><h2 class="text" data-v-ce46bc99>前端工程化</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-ce46bc99><span class="vpi-chevron-right caret-icon" data-v-ce46bc99></span></div></div><div class="items" data-v-ce46bc99><!--[--><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/engi/rule/" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>前端规范搭建</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/engi/monorepo/" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>Monorepo理论与实践</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/base/performance/" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>前端常见性能优化方案</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/engi/deploy/" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>前端资源部署策略</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/engi/microFront/" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>微前端架构浅析</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/engi/CICD/" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>前端视角看CICD</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-21a3c426><section class="VPSidebarItem level-0 collapsible has-active" data-v-21a3c426 data-v-ce46bc99><div class="item" role="button" tabindex="0" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><h2 class="text" data-v-ce46bc99>前端基础</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-ce46bc99><span class="vpi-chevron-right caret-icon" data-v-ce46bc99></span></div></div><div class="items" data-v-ce46bc99><!--[--><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/base/debugger/" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>前端最全Debugger技巧</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/base/Ai/" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>从前端视角看AI世界</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/source/vue2/reactive/" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>Vue2源码之响应式及队列调度</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/base/TS/" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>TS入门及实践</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/base/designMode/" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>前端常用设计模式</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/base/react/redux/" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>Redux入门及实践</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/practice/blog/" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>10分钟搭建一个属于自己的博客</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/base/algorithm/" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>做过的算法题合集</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-21a3c426><section class="VPSidebarItem level-0 collapsible" data-v-21a3c426 data-v-ce46bc99><div class="item" role="button" tabindex="0" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><h2 class="text" data-v-ce46bc99>Uniapp跨端开发</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-ce46bc99><span class="vpi-chevron-right caret-icon" data-v-ce46bc99></span></div></div><div class="items" data-v-ce46bc99><!--[--><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/mini/packageSize/" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>包体积优化</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/mini/var/" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>自定义编译变量及环境变量</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/mini/thirdSDK/" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>Uniapp对接微信原生SDK</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/mini/app/" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>Uniapp开发App入门与实践</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-ce46bc99 data-v-ce46bc99><div class="item" data-v-ce46bc99><div class="indicator" data-v-ce46bc99></div><a class="VPLink link link" href="/vitePress/front/mini/publish.html" data-v-ce46bc99><!--[--><p class="text" data-v-ce46bc99>App上架各应用市场攻略</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-b282b196 data-v-f1505e60><div class="VPDoc has-sidebar has-aside" data-v-f1505e60 data-v-c06fab7a><!--[--><!--]--><div class="container" data-v-c06fab7a><div class="aside" data-v-c06fab7a><div class="aside-curtain" data-v-c06fab7a></div><div class="aside-container" data-v-c06fab7a><div class="aside-content" data-v-c06fab7a><div class="VPDocAside" data-v-c06fab7a data-v-9e22cc39><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-9e22cc39 data-v-8d97b77b><div class="content" data-v-8d97b77b><div class="outline-marker" data-v-8d97b77b></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-8d97b77b>On this page</div><ul class="VPDocOutlineItem root" data-v-8d97b77b data-v-4c7ef942><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-9e22cc39></div><!--[--><!--]--><div class="VPDocAsideCarbonAds" data-v-9e22cc39><div class="VPCarbonAds" data-v-4235ae52></div></div><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-c06fab7a><div class="content-container" data-v-c06fab7a><!--[--><!--]--><main class="main" data-v-c06fab7a><div style="position:relative;" class="vp-doc _vitePress_front_source_vue2_reactive_" data-v-c06fab7a><div><h1 id="vue2源码之响应式及队列调度" tabindex="-1">Vue2源码之响应式及队列调度 <a class="header-anchor" href="#vue2源码之响应式及队列调度" aria-label="Permalink to &quot;Vue2源码之响应式及队列调度&quot;">​</a></h1><h2 id="前言" tabindex="-1">前言 <a class="header-anchor" href="#前言" aria-label="Permalink to &quot;前言&quot;">​</a></h2><p>相信使用过Vue的前端开发者对于Vue数据驱动的思想已经非常熟悉，但是究竟Vue是如何做到修改数据后，视图自动更新的呢？本文将结合源码探究从数据变化到视图更新的过程中发生了哪些事情</p><h2 id="一切的起点-new-vue" tabindex="-1">一切的起点- new Vue <a class="header-anchor" href="#一切的起点-new-vue" aria-label="Permalink to &quot;一切的起点- new Vue&quot;">​</a></h2><p><img src="/vitePress/assets/image.9_7cBWoE.png" alt="alt text"></p><p>从main.js中的new Vue，到$mount将视图及数据绑定，并且挂载真实Dom之间，Vue内部发生了些什么事呢，我们结合源码一起看看</p><p><img src="/vitePress/assets/image-1.CF7kOtFK.png" alt="alt text"></p><p>上述代码是Vue的构造器函数，我们能看到new Vue时，其实只是调用了_init函数，并且将我们定义的options传入，options即为我们业务代码里export default 暴露的对象，里面包含了data,props,computed,watch,methods等等</p><p><img src="/vitePress/assets/image-2.DDfAyQKs.png" alt="alt text"></p><p>我们可以看出在_init中，vue完成了大部分的初始化工作，包括生命周期，事件，render函数，各个状态值等等，为了减少阅读成本，我们先只深入<strong>initState</strong>中，看看Vue是做到数据驱动视图的</p><p><img src="/vitePress/assets/image-3.CKXR_zBR.png" alt="alt text"></p><p>在initState中，主要对props,methods,data,computed,watch分别进行了初始化，初始化的过程就是数据实现响应式的过程</p><p><strong>initData</strong></p><p><img src="/vitePress/assets/image-4.Gmurg2iD.png" alt="alt text"></p><p>从上述代码里我们可以看到，在observe（data）调用前，所有的代码都是一些边界处理及错误的前置判断</p><p>首先会根据你传入的data是函数还是对象，来决定data的获取方式，拿到data后，会去遍历data里的key，分别和methods及props中的key进行对比，看是否同名，我们能够直观的看出，具体优先级是props&gt; data &gt; methods的</p><p>在处理完各种判断后，调用了observe函数并且将data进行了传入</p><p><img src="/vitePress/assets/image-5.BXJ142gf.png" alt="alt text"></p><p>在observe中，也是先做了一些前置判断，如已经observe过的对象会有一个__ob__属性，这个时候就不会再次调observe减少性能开销，接着if判断中，有许多判断条件做边界处理，我们逐个讲解下</p><ol><li>shouldObserve: 固定变量，写死的true，vue开发人员用于代码调试时使用</li><li>ssrMockReactivity || !isServerRendering : 当vue是服务端渲染的情况，这里暂不探究</li><li>isArray || isPlainObject : 只有数组和对象才会进行observe处理，这里非常重要，后续observe函数会被递归调用，用于响应式的深度处理，如data:{obj1:{obj2:{name:&#39;zs&#39;} } },obj2也具备响应式，该判断条件作为递归的结束条件</li><li>Object,isExtensible, !value.__v_skip , !isRef(value), !value instanceof VNode: 这些判断条件分别是判断对象是否能够扩展，是否需要跳过observe,是否是compositionApi的ref函数处理过，是否本身就是VNode(虚拟节点)，我们暂时都默认为true即可</li></ol><p>判断条件都符合后，这里会new Observer对象 ，并且传入了value,这里的value，我们可以看出，其实就是我们写的options中的data</p><p><img src="/vitePress/assets/image-6.BEsp57nI.png" alt="alt text"></p><p>Observer的构造器函数中，我们可以看到主要是做了以下几件事</p><ol><li>将传入的对象放到实例的value上</li><li>确定shallow的值，用于判断本次监听是深度还是非深度，非深度仅监听对象地址值变化，深度的话会同时监听对象里的属性变化</li><li>new一个Dep对象，并且放到该observer实例的dep属性上</li><li>将当前实例同时添加到传入的value对象上的__ob__属性上，避免后续同个对象多次执行observer</li><li>如果Value是数组的话调用observeArray函数进行监听</li><li>如果Value是对象的话，遍历其所有属性，每次都会调用defineReactive函数去进行响应式监听</li></ol><p><img src="/vitePress/assets/image-7.DGXH1lcN.png" alt="alt text"></p><p>我们先来看如果value是数组的情况，其实这里会对数组的每一项遍历，本质上是再次调用observe函数，形成递归，如果当前遍历项是数组，则会在observe调用new Observer时继续执行observeArray, 如果是对象则会在new observer时调用defineReactive，如果是基本数据类型，则在observe函数中不符合if条件，停止递归</p><p><img src="/vitePress/assets/image-8.Crjc9_02.png" alt="alt text"></p><p>defineReactive是响应式体系中最核心的一个函数，我们常说的defineProperty监听对象各个属性的set和get就是在这里完成的</p><p>结合前文，我们知道当前调用defineReactive是在new Observer时，判断当前的value是对象时，会遍历该对象的key，并且每次将对象及当前遍历的key传入defineReactive,所以我们能够知道，defineReactive的执行单位是对象上的每个key</p><p>整个defineReactive中最核心的逻辑如下：</p><ol><li>实例化一个Dep对象，并且通过闭包的方式与在传入的obj及key形成访问关联,这个dep实例的作用是用于存放及派发watcher，在此暂时可以简单将watcher理解为一个个回调函数，在监听的数据变化后，会去调用这些回调函数来更新视图或者处理其它副作用，后面会详细介绍各类watcher</li><li>通过Object.defineProperty去对传入的对象进行数据劫持，在get的时候（也就是访问对象的当前key时）会调取步骤1中创建的dep实例的depend方法，收集watcher，在set的时候（也就是修改当前对象当前key的值时）会去调用dep实例的notify函数，去派发watcher，派发watcher本质上就是执行一个个回调函数，其中包含了通过操作dom来更新视图得update函数</li></ol><p>到目前为止，我们已经初步了解了从new Vue到data的各个属性具备响应式的全过程，我们先对这个过程的调用栈进行小结</p><p>new Vue(options) =&gt; _init(options)=&gt; initState(vm)=&gt;initData(vm)=&gt; observe(data)=&gt; new Observer(data) =&gt; defineReactive(data,key)=&gt;get=&gt;dep.depend=&gt;set=&gt;dep.notify=&gt;_update()</p><p>在该过程中，options中的data的各个属性值均通过Object.defineProperty进行数据劫持，在get时，会去调取dep实例的depend方法，收集watcher，在set时，会去调用dep实例的notify方法，调用前面get时收集到的watcher, 而这些watcher本质是就是函数，其中就包括了Vue._update这个更新视图的函数，执行时，Vue就会通过操作dom的方式让真实Dom更新，从而达到页面视图重新渲染的目的</p><h2 id="vue的核心类" tabindex="-1">Vue的核心类 <a class="header-anchor" href="#vue的核心类" aria-label="Permalink to &quot;Vue的核心类&quot;">​</a></h2><p>在第一部分 new Vue的章节中，我们对从数据变化，到视图更新的流程有了大致的了解，但是一些细节上的东西还是比较模糊的，比如 dep实例的depend 和 notify函数究竟是怎么收集和派发watcher的,watcher又是什么，在哪生成，有什么作用等等，接下来我们会讲解vue2响应式体系中除了上文已经提到的Observer外，另外2个核心的类,Dep及Watcher</p><h3 id="dep" tabindex="-1">Dep <a class="header-anchor" href="#dep" aria-label="Permalink to &quot;Dep&quot;">​</a></h3><p>在Vue的响应式系统中，Dep类扮演着&quot;依赖收集器&quot;的角色，它负责收集和管理数据属性的所有依赖（即Watcher实例）。每个响应式属性都会对应一个Dep实例。让我们通过源码深入了解它的实现：</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// src/core/observer/dep.js</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">let</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> uid</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // 用于生成唯一的dep id</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">export</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> default</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> class</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Dep</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">  static</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> target</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">?</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">Watcher</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // 当前正在计算的watcher</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">number</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">               // dep实例的唯一标识</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  subs</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">Array</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&lt;</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">Watcher</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     // 存储该dep收集的所有watcher</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">  constructor</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">    this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> uid</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">++</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">    this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">subs</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> []</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // 添加一个watcher到订阅列表</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  addSub</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">sub</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">Watcher</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">    this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">subs</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">push</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">sub</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // 从订阅列表中移除一个watcher</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  removeSub</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">sub</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">Watcher</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    remove</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">subs</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> sub</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // 依赖收集，当前watcher订阅这个dep</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  depend</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">Dep</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">target</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">      Dep</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">target</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">addDep</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // 通知所有订阅者进行更新</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  notify</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // 复制订阅者列表</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    const</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> subs</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">subs</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">slice</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // 按照watcher的创建顺序排序，确保更新的顺序：父组件的watcher先于子组件</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    subs</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sort</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">((</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">a</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> b</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =&gt;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> a</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">id</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> -</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> b</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // 逐个通知watcher进行更新</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    for</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">let</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> i</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> l</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> subs</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">length</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> i</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> &lt;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> l</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> i</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">++</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">      subs</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">i</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">].</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">update</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 全局唯一的target，同一时间只能有一个watcher被计算</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">Dep</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">target</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> null</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">const</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> targetStack</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> []</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 在需要收集依赖时将当前watcher推入栈中</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">export</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> function</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> pushTarget</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">target</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">?</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">Watcher</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  targetStack</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">push</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">target</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  Dep</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">target</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> target</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 依赖收集完成后将当前watcher从栈中弹出</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">export</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> function</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> popTarget</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  targetStack</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">pop</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  Dep</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">target</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> targetStack</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">targetStack</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">length</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> -</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><p>Dep类的核心设计要点：</p><ol><li><p><strong>全局唯一的Dep.target</strong>：</p><ul><li>通过静态属性Dep.target存储当前正在计算的watcher</li><li>使用targetStack栈管理watcher的收集顺序</li><li>确保同一时刻只有一个watcher被收集为依赖</li></ul></li><li><p><strong>依赖收集过程</strong>：</p><ul><li>当访问响应式数据时，触发getter</li><li>getter中调用dep.depend()收集当前watcher作为依赖</li><li>depend方法通过Dep.target.addDep建立dep和watcher的双向关系</li></ul></li><li><p><strong>更新通知机制</strong>：</p><ul><li>数据变化时，setter调用dep.notify()</li><li>notify方法会对订阅者进行排序，确保更新顺序的正确性</li><li>遍历所有订阅者，调用其update方法进行更新</li></ul></li></ol><h3 id="watcher" tabindex="-1">Watcher <a class="header-anchor" href="#watcher" aria-label="Permalink to &quot;Watcher&quot;">​</a></h3><p>Watcher是Vue响应式系统的另一个核心类，它负责执行数据变化时的更新操作。在Vue中，Watcher有三种主要类型，每种类型都有其特定的用途和行为：</p><ol><li><p><strong>渲染Watcher (Render Watcher)</strong>：</p><ul><li>在组件挂载时创建($mount())</li><li>负责组件视图的更新</li><li>优先级最低</li></ul></li><li><p><strong>计算属性Watcher (Computed Watcher)</strong>：</p><ul><li>在初始化computed时创建(initComputed$1())</li><li>具有lazy特性，只在被访问时才计算</li><li>优先级中等</li></ul></li><li><p><strong>用户Watcher (User Watcher)</strong>：</p><ul><li>通过watch选项或$watch API创建 (initWatch)</li><li>用于监听数据变化并执行回调</li><li>优先级最高</li></ul></li></ol><p>让我们看看Watcher类的具体实现：</p><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// src/core/observer/watcher.js</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">export</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> default</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> class</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Watcher</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  vm</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">Component</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">           // 组件实例</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  expression</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">string</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">      // 要监听的表达式</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  cb</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">Function</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">           // 回调函数</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">number</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">             // watcher的唯一标识</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  deep</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">boolean</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">          // 是否深度监听</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  user</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">boolean</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">          // 是否是用户watcher</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  lazy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">boolean</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">          // 是否是计算属性watcher</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  sync</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">boolean</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">          // 是否同步更新</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  dirty</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">boolean</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">         // 计算属性是否需要重新计算</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  active</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">boolean</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // watcher是否激活</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  deps</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">Array</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&lt;</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">Dep</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">       // 当前watcher依赖的所有dep</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  newDeps</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">Array</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&lt;</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">Dep</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // 新一轮依赖收集的dep</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  depIds</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">SimpleSet</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">      // 当前依赖的dep id集合</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  newDepIds</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">SimpleSet</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   // 新依赖的dep id集合</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  getter</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">Function</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">       // 获取监听值的函数</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  value</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">any</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">             // 当前值</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">  constructor</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    vm</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">Component</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    expOrFn</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">string</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> | </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">Function</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    cb</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">Function</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    options</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">?</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">?</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">Object</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    isRenderWatcher</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">?</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">boolean</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  )</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">    this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">vm</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> vm</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // 如果是渲染watcher，保存到vm._watcher</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">isRenderWatcher</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">      vm</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">_watcher</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> this</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    vm</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">_watchers</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">push</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // 初始化配置</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">options</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">      this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">deep</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !!</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">options</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">deep</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">      this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">user</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !!</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">options</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">user</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">      this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">lazy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !!</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">options</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">lazy</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">      this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">sync</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !!</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">options</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">sync</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">      this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">before</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> options</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">before</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> else</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">      this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">deep</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">user</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">lazy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">sync</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> false</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    </span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">    this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">cb</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> cb</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">    this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ++</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">uid</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">    this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">active</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">    this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">dirty</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">lazy</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // 计算属性watcher初始化时dirty为true</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // 用于依赖收集</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">    this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">deps</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> []</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">    this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">newDeps</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> []</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">    this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">depIds</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Set</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">    this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">newDepIds</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Set</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // 设置getter</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">typeof</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> expOrFn</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ===</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">function</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">      this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">getter</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> expOrFn</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> else</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">      this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">getter</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> parsePath</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">expOrFn</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // 将表达式解析为getter函数</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // 非lazy的情况下，直接求值</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">    this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">value</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">lazy</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">      ?</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> undefined</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">      :</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">get</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  /**</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   * 计算getter，并重新收集依赖</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   */</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  get</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    pushTarget</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    let</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> value</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    const</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> vm</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">vm</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    try</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">      value</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">getter</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">call</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">vm</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> vm</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> catch</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">e</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">      if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">user</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        handleError</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">e</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> vm</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">getter for watcher &quot;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">${</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">expression</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">&quot;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      }</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> else</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        throw</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> e</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> finally</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">      // 深度监听的处理</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">      if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">deep</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        traverse</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">value</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      }</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      popTarget</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">      this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cleanupDeps</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    return</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> value</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  /**</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   * 添加依赖</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   */</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  addDep</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">dep</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">Dep</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    const</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> dep</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">id</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">!</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">newDepIds</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">has</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">))</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">      this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">newDepIds</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">add</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">      this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">newDeps</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">push</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">dep</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">      if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">!</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">depIds</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">has</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">))</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">        dep</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">addSub</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  /**</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   * 清理依赖收集</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   */</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  cleanupDeps</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    let</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> i</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">deps</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">length</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    while</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">i</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">--</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">      const</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> dep</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">deps</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">i</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">      if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">!</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">newDepIds</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">has</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">dep</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">))</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">        dep</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">removeSub</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // 交换新旧依赖集合</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    let</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> tmp</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">depIds</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">    this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">depIds</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">newDepIds</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">    this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">newDepIds</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> tmp</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">    this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">newDepIds</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">clear</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    tmp</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">deps</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">    this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">deps</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">newDeps</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">    this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">newDeps</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> tmp</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">    this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">newDeps</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">length</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  /**</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   * 订阅者接口，当依赖发生改变时调用</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   */</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  update</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">lazy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">      // 计算属性watcher，仅将dirty置为true</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">      this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">dirty</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> else</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">sync</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">      // 同步watcher，直接运行</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">      this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">run</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> else</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">      // 异步watcher，加入队列</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      queueWatcher</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  /**</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   * 调度者接口，实际执行更新</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   */</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  run</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">active</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">      const</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> value</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">get</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">      if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">        value</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">value</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ||</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        isObject</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">value</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ||</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">        this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">deep</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      )</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // 设置新值</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        const</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> oldValue</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">value</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">        this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">value</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> value</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">user</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">          try</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">            this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">cb</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">call</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">vm</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> value</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> oldValue</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">          }</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> catch</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">e</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">            handleError</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">e</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">vm</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">callback for watcher &quot;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">${</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">expression</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">&quot;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">          }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        }</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> else</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">          this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">cb</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">call</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">vm</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> value</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> oldValue</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br></div></div><p>Watcher类的核心设计要点：</p><ol><li><p><strong>依赖管理</strong>：</p><ul><li>使用deps和newDeps数组存储依赖的Dep实例</li><li>通过depIds和newDepIds集合去重</li><li>cleanupDeps方法优化依赖收集，移除不需要的依赖</li></ul></li><li><p><strong>更新机制</strong>：</p><ul><li>lazy：计算属性的懒计算机制</li><li>sync：同步更新机制</li><li>queueWatcher：异步更新队列</li></ul></li><li><p><strong>值管理</strong>：</p><ul><li>value属性存储当前值</li><li>get方法获取新值</li><li>run方法进行值对比和更新</li></ul></li></ol><p>通过这样精心设计的Dep和Watcher类，Vue实现了高效的响应式系统：</p><ul><li>Dep负责收集和管理依赖，实现了数据到watcher的映射</li><li>Watcher负责执行更新，实现了不同场景下的响应式更新策略</li><li>两者通过双向关联，共同构建了Vue的响应式更新机制</li></ul><h2 id="队列更新机制的实现" tabindex="-1">队列更新机制的实现 <a class="header-anchor" href="#队列更新机制的实现" aria-label="Permalink to &quot;队列更新机制的实现&quot;">​</a></h2><p>Vue的队列更新机制是一个精心设计的异步更新系统，它包含两个重要的队列：</p><ol><li><strong>watcher队列（queue）</strong>：用于收集需要更新的watcher</li><li><strong>callbacks队列</strong>：用于收集nextTick回调函数</li></ol><p>让我们深入了解这个机制的实现细节：</p><h3 id="_1-watcher队列的实现" tabindex="-1">1. Watcher队列的实现 <a class="header-anchor" href="#_1-watcher队列的实现" aria-label="Permalink to &quot;1. Watcher队列的实现&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// src/core/observer/scheduler.js</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">const</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> queue</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">Array</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&lt;</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">Watcher</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt; =</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> []</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">let</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> has</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: { [</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">key</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">number</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]: </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">?true</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> } =</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {}</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">let</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> waiting</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> false</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">let</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> flushing</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> false</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">let</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> index</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">/**</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> * 将watcher推入队列</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> */</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">export</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> function</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> queueWatcher</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">watcher</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">Watcher</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">  const</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> watcher</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">id</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // 检查watcher是否已经在队列中</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">  if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">has</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ==</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> null</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    has</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">!</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">flushing</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">      // 如果队列还没有开始刷新，直接push到队列末尾</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">      queue</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">push</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">watcher</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> else</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">      // 如果队列正在刷新，需要按照id大小插入到合适的位置</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">      // 保证父组件的watcher排在子组件的watcher前面</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">      let</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> i</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> queue</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">length</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> -</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">      while</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">i</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> &gt;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> index</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> queue</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">i</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">].</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> &gt;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> watcher</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">        i</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">--</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      }</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">      queue</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">splice</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">i</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> +</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> watcher</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    </span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">!</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">waiting</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">      waiting</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">      </span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">      if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">process</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">env</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">NODE_ENV</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !==</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">production</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">config</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">async</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // 非生产环境且配置为同步更新时，直接刷新队列</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        flushSchedulerQueue</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        return</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      }</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">      // 将刷新队列的操作推入nextTick</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      nextTick</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">flushSchedulerQueue</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">/**</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> * 刷新调度队列</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> */</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">function</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> flushSchedulerQueue</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  currentFlushTimestamp</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> getNow</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  flushing</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">  let</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> watcher</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> id</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">  </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // 队列排序，确保：</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // 1. 组件更新从父到子（因为父组件总是在子组件之前创建）</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // 2. 用户的watcher在渲染watcher之前运行（因为用户的watcher先创建）</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // 3. 如果一个组件在父组件的watcher运行时被销毁，它的watcher可以被跳过</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  queue</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sort</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">((</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">a</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> b</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =&gt;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> a</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">id</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> -</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> b</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">  </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // 不缓存队列长度，因为在执行过程中可能会有新的watcher加入</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">  for</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">index</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> index</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> &lt;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> queue</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">length</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> index</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">++</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    watcher</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> queue</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">index</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">watcher</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">before</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">      watcher</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">before</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> watcher</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">id</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    has</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> null</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    watcher</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">run</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // 开发环境下检查是否存在无限更新循环</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">process</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">env</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">NODE_ENV</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !==</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">production</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> has</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> null</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">      circular</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">circular</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ||</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> +</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">      if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">circular</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> &gt;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> MAX_UPDATE_COUNT</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        warn</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">          &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">You may have an infinite update loop </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> +</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">            watcher</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">user</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">              ?</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">in watcher with expression &quot;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">watcher</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">expression</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">&quot;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">              :</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">in a component render function.</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">          ),</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">          watcher</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">vm</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        )</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        break</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">  </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // 在刷新队列之后，调用相应的生命周期钩子</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">  const</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> updatedQueue</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> queue</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">slice</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  resetSchedulerState</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">  </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // 调用updated钩子</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  callUpdatedHooks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">updatedQueue</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">/**</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> * 重置调度器状态</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> */</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">function</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> resetSchedulerState</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  index</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> queue</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">length</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  has</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {}</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">  if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">process</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">env</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">NODE_ENV</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !==</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">production</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    circular</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {}</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  }</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  waiting</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> flushing</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> false</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br></div></div><h3 id="_2-nexttick实现及callbacks队列" tabindex="-1">2. nextTick实现及callbacks队列 <a class="header-anchor" href="#_2-nexttick实现及callbacks队列" aria-label="Permalink to &quot;2. nextTick实现及callbacks队列&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// src/core/util/next-tick.js</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">const</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> callbacks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> []</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">let</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> pending</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> false</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">let</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> timerFunc</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">export</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> function</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> nextTick</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cb</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">?</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">Function</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ctx</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">?</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">: </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">Object</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">  let</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> _resolve</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">  </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // 将回调函数包装后放入callbacks数组</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  callbacks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">push</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =&gt;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">cb</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">      try</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">        cb</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">call</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ctx</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      }</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> catch</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">e</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        handleError</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">e</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ctx</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">nextTick</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> else</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">_resolve</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      _resolve</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ctx</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  })</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">  </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // 如果还没有pending的刷新，则启动一个</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">  if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">!</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">pending</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    pending</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    timerFunc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">  </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // 如果没有提供回调，返回一个Promise</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">  if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">!</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">cb</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> typeof</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> Promise</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !==</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">undefined</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    return</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> new</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> Promise</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">resolve</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =&gt;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">      _resolve</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> resolve</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    })</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 异步降级方案的实现</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">typeof</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> Promise</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !==</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">undefined</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // 使用Promise.then</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">  const</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> p</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> Promise</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">resolve</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  timerFunc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =&gt;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    p</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">then</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">flushCallbacks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> else</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">typeof</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> MutationObserver</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !==</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">undefined</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // 使用MutationObserver</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">  let</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> counter</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">  const</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> observer</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> MutationObserver</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">flushCallbacks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">  const</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> textNode</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> document</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">createTextNode</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">String</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">counter</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">))</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  observer</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">observe</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">textNode</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    characterData</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  })</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  timerFunc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =&gt;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    counter</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">counter</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> +</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> %</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    textNode</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">data</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> String</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">counter</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> else</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">typeof</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> setImmediate</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !==</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">undefined</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // 使用setImmediate</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  timerFunc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =&gt;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    setImmediate</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">flushCallbacks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> else</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // 最后降级到setTimeout</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  timerFunc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =&gt;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    setTimeout</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">flushCallbacks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">/**</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> * 刷新所有callbacks</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> */</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">function</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> flushCallbacks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  pending</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> false</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">  const</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> copies</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> callbacks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">slice</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  callbacks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">length</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">  for</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">let</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> i</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> i</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> &lt;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> copies</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">length</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> i</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">++</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    copies</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">i</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]()</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br></div></div><h3 id="_3-队列更新机制的核心设计" tabindex="-1">3. 队列更新机制的核心设计 <a class="header-anchor" href="#_3-队列更新机制的核心设计" aria-label="Permalink to &quot;3. 队列更新机制的核心设计&quot;">​</a></h3><ol><li><p><strong>双队列设计的意义</strong>：</p><ul><li><code>queue</code>队列用于收集watcher，确保同一个watcher在一个tick内只更新一次</li><li><code>callbacks</code>队列用于收集nextTick回调，实现微任务级别的更新控制</li><li>两个队列的配合确保了更新的顺序性和性能</li></ul></li><li><p><strong>更新流程的完整链路</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code" tabindex="0"><code><span class="line"><span>数据变化 </span></span>
<span class="line"><span>→ 触发setter </span></span>
<span class="line"><span>→ dep.notify() </span></span>
<span class="line"><span>→ watcher.update() </span></span>
<span class="line"><span>→ queueWatcher() </span></span>
<span class="line"><span>→ nextTick(flushSchedulerQueue) </span></span>
<span class="line"><span>→ 下一个微任务执行更新</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li><li><p><strong>优先级控制</strong>：</p><ul><li>组件更新优先级：父组件 &gt; 子组件</li><li>watcher优先级：用户watcher &gt; 渲染watcher</li><li>队列排序确保了更新顺序的正确性</li></ul></li><li><p><strong>性能优化设计</strong>：</p><ul><li>watcher去重：通过has对象实现O(1)的查重</li><li>异步更新：避免同步更新带来的性能问题</li><li>批量处理：多个更新在一个tick内批量处理</li></ul></li><li><p><strong>异常处理机制</strong>：</p><ul><li>循环更新检测：通过circular对象检测无限更新循环</li><li>错误捕获：对每个回调的执行都有try-catch保护</li><li>降级处理：对不同环境提供降级的异步实现</li></ul></li><li><p><strong>扩展性考虑</strong>：</p><ul><li>支持Promise形式的调用</li><li>提供before钩子用于更新前的准备工作</li><li>支持用户配置同步更新模式</li></ul></li></ol><h3 id="_4-实际应用示例" tabindex="-1">4. 实际应用示例 <a class="header-anchor" href="#_4-实际应用示例" aria-label="Permalink to &quot;4. 实际应用示例&quot;">​</a></h3><div class="language-javascript vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">export</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> default</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  data</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    return</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> count</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  },</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  methods</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    increment</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">      // 这里的更新会被推入队列</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">      this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">count</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">++</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">      // 立即获取DOM是获取不到更新后的结果的</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">      console</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">log</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">$el</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">textContent</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // 显示更新前的值</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">      </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">      // 使用nextTick等待DOM更新完成</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">      this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$nextTick</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =&gt;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">        console</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">log</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">$el</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">textContent</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // 显示更新后的值</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      })</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">      </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">      // 也可以使用async/await语法</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">      async</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> function</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> update</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        await</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$nextTick</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">        console</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">log</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">this</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">$el</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">textContent</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // 显示更新后的值</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>通过这样精心设计的队列更新机制，Vue实现了高效的异步更新策略，既保证了更新的正确性，又避免了不必要的性能开销。这个机制是Vue响应式系统高效运行的重要保证。</p></div></div></main><footer class="VPDocFooter" data-v-c06fab7a data-v-04943399><!--[--><!--]--><!----><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-04943399><span class="visually-hidden" id="doc-footer-aria-label" data-v-04943399>Pager</span><div class="pager" data-v-04943399><a class="VPLink link pager-link prev" href="/vitePress/front/base/Ai/" data-v-04943399><!--[--><span class="desc" data-v-04943399>Previous page</span><span class="title" data-v-04943399>从前端视角看AI世界</span><!--]--></a></div><div class="pager" data-v-04943399><a class="VPLink link pager-link next" href="/vitePress/front/base/TS/" data-v-04943399><!--[--><span class="desc" data-v-04943399>Next page</span><span class="title" data-v-04943399>TS入门及实践</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"ailargemodel_embedding.md\":\"DYCfKEyp\",\"ailargemodel_jibenyuanli.md\":\"By6RuUt4\",\"ailargemodel_rag.md\":\"CxshUhB_\",\"ailargemodel_technicalterm.md\":\"D2j8tLLU\",\"api_functions.md\":\"BpngT7Yq\",\"api_label.md\":\"BgRVLQqc\",\"api_path.md\":\"ReNKQCPZ\",\"back_framework_chooseframework_index.md\":\"D8_sDfDG\",\"back_framework_database_index.md\":\"DZEVRG0V\",\"back_framework_mysql_index.md\":\"Dv7CItqn\",\"back_framework_nest_index.md\":\"daMl_1Yh\",\"back_framework_redis_index.md\":\"9OlQopfV\",\"back_framework_structure_index.md\":\"B1KxEhQX\",\"component_index.md\":\"Dp-B1WH1\",\"component_swy-ui_jichu_button.md\":\"-OITfx8Y\",\"component_toco-ui_biji_oneday.md\":\"0gtHAqMD\",\"component_toco-ui_drawerform_index.md\":\"BcFRBEfa\",\"component_toco-ui_modalform_index.md\":\"Du4XIJhX\",\"component_toco-ui_profield_autocomplete.md\":\"ClA3N_bm\",\"component_toco-ui_profield_avatar.md\":\"Bk0PyjEI\",\"component_toco-ui_profield_button.md\":\"nL5FUgbO\",\"component_toco-ui_profield_cascader.md\":\"RPbwxocA\",\"component_toco-ui_profield_checkbox.md\":\"C8gasLNo\",\"component_toco-ui_profield_colorpicker.md\":\"D6SCO4T0\",\"component_toco-ui_profield_datepicker.md\":\"D5y5PypI\",\"component_toco-ui_profield_divider.md\":\"CxY3jbKl\",\"component_toco-ui_profield_image.md\":\"WNId7TTB\",\"component_toco-ui_profield_inputnumber.md\":\"BxVMITGO\",\"component_toco-ui_profield_inputtag.md\":\"DyNTrjp9\",\"component_toco-ui_profield_mention.md\":\"B92hV8st\",\"component_toco-ui_profield_price.md\":\"DT5oNVgT\",\"component_toco-ui_profield_radio.md\":\"_OkKawjJ\",\"component_toco-ui_profield_rate.md\":\"C2kQBVKq\",\"component_toco-ui_profield_segmented.md\":\"BKIU1Daa\",\"component_toco-ui_profield_select.md\":\"D1jtmiKr\",\"component_toco-ui_profield_selectv2.md\":\"DSm0geHm\",\"component_toco-ui_profield_slider.md\":\"DoZBs5Hw\",\"component_toco-ui_profield_switch.md\":\"oeM8SM6g\",\"component_toco-ui_profield_text.md\":\"Bj10tWNz\",\"component_toco-ui_profield_timepicker.md\":\"ZHzIobT7\",\"component_toco-ui_profield_timeselect.md\":\"DGL9WKBd\",\"component_toco-ui_profield_transfer.md\":\"CfZauC4b\",\"component_toco-ui_profield_treeselect.md\":\"DprHLjLr\",\"component_toco-ui_profield_upload.md\":\"CbAubKjJ\",\"component_toco-ui_proform_basic.md\":\"B-K_KYUj\",\"component_toco-ui_proform_effects.md\":\"B1VnjrTD\",\"component_toco-ui_proformfield_autocomplete.md\":\"B_nPMRJq\",\"component_toco-ui_proformfield_avatar.md\":\"D8jJAaCE\",\"component_toco-ui_proformfield_button.md\":\"DSQkLHIU\",\"component_toco-ui_proformfield_cascader.md\":\"DgjSx3eP\",\"component_toco-ui_proformfield_checkbox.md\":\"jhkNSLA5\",\"component_toco-ui_proformfield_colorpicker.md\":\"BGTkCdv4\",\"component_toco-ui_proformfield_datepicker.md\":\"woti3h0k\",\"component_toco-ui_proformfield_divider.md\":\"UBXCFJuQ\",\"component_toco-ui_proformfield_image.md\":\"94VMbVRI\",\"component_toco-ui_proformfield_inputnumber.md\":\"BzCthAKh\",\"component_toco-ui_proformfield_inputtag.md\":\"C1tcaj-G\",\"component_toco-ui_proformfield_mention.md\":\"DzD4ld3P\",\"component_toco-ui_proformfield_radio.md\":\"OixwqNj1\",\"component_toco-ui_proformfield_rate.md\":\"BrqKS4WH\",\"component_toco-ui_proformfield_segmented.md\":\"DwenD4RD\",\"component_toco-ui_proformfield_select.md\":\"B1-zuxMK\",\"component_toco-ui_proformfield_selectv2.md\":\"r2Re6yzq\",\"component_toco-ui_proformfield_slider.md\":\"tMLkTuBv\",\"component_toco-ui_proformfield_switch.md\":\"D2fSKU5O\",\"component_toco-ui_proformfield_text.md\":\"Bzu1tb6w\",\"component_toco-ui_proformfield_timepicker.md\":\"Co0HjG7d\",\"component_toco-ui_proformfield_timeselect.md\":\"C8azuzQU\",\"component_toco-ui_proformfield_transfer.md\":\"CigKelPc\",\"component_toco-ui_proformfield_treeselect.md\":\"C__1VlNv\",\"component_toco-ui_proformfield_upload.md\":\"D6roC-dS\",\"component_toco-ui_proinputtag_index.md\":\"BlrOXWvv\",\"component_toco-ui_proselect_basic.md\":\"DhQU9xHl\",\"component_toco-ui_proselect_table.md\":\"DJL3-3Tn\",\"component_toco-ui_proselect_waterfall.md\":\"CVfbJcr4\",\"component_toco-ui_protable_basic.md\":\"BE7mMucV\",\"component_toco-ui_protable_editable-cell.md\":\"DNiDcbjJ\",\"component_toco-ui_protable_editable-multiple.md\":\"DE9a1IYb\",\"component_toco-ui_protable_editable-only.md\":\"Dm415icE\",\"component_toco-ui_protable_editable-single.md\":\"CAT14h2m\",\"component_toco-ui_protable_export.md\":\"Bq2P5Ikb\",\"component_toco-ui_protable_import.md\":\"DaknEZGa\",\"component_toco-ui_protable_table-ref.md\":\"0oTYqE-y\",\"component_toco-ui_protable_toolbar-buttons.md\":\"DvamzSxe\",\"component_toco-ui_protable_toolbar-filters.md\":\"_fbFesmh\",\"component_toco-ui_protable_toolbar-search.md\":\"BqzjIj4D\",\"component_toco-ui_protable_toolbar.md\":\"BWwGSCqC\",\"conventionalcommits_git.md\":\"C3EA482P\",\"front_base_ai_index.md\":\"CIRUJvt-\",\"front_base_algorithm_index.md\":\"DKOhE6Zc\",\"front_base_debugger_index.md\":\"BJcGgg_h\",\"front_base_designmode_index.md\":\"Dp4jGwXj\",\"front_base_es6_index.md\":\"D8yTNn-y\",\"front_base_performance_index.md\":\"CJCYNJmq\",\"front_base_react_redux_index.md\":\"C2xNl1kI\",\"front_base_ts_index.md\":\"4ixVRQmf\",\"front_engi_cicd_index.md\":\"BEGBbD-T\",\"front_engi_components_index.md\":\"C2sbw6HB\",\"front_engi_deploy_index.md\":\"C6NJoMjv\",\"front_engi_microfront_index.md\":\"BBNs7X6k\",\"front_engi_monorepo_index.md\":\"eLUO4I24\",\"front_engi_rule_index.md\":\"CJ55HBgr\",\"front_interview_anti-vibration-throttling.md\":\"BM9PKBot\",\"front_interview_arrary.md\":\"uywyUfFg\",\"front_interview_box-model.md\":\"X0VzpyMY\",\"front_interview_browser-server-interaction.md\":\"Bx4Cw8Be\",\"front_interview_call-apply-bind.md\":\"B2YoXVJq\",\"front_interview_closure.md\":\"Bg0ufNVa\",\"front_interview_component-value-transfer.md\":\"BkRgx7wM\",\"front_interview_copy.md\":\"zQmDyFQz\",\"front_interview_cross-domain.md\":\"BrdtmSyf\",\"front_interview_css-priority.md\":\"DeITzpZ6\",\"front_interview_css3_newfeatures.md\":\"DLQiDITB\",\"front_interview_data-type.md\":\"DPj2Kf8s\",\"front_interview_div-center.md\":\"e_b9JvPF\",\"front_interview_dom-tree.md\":\"k-79Rzni\",\"front_interview_encapsulated.md\":\"DyWMuu7w\",\"front_interview_es6.md\":\"D-nh750A\",\"front_interview_event-cycle-mechanism.md\":\"JUxIWkvo\",\"front_interview_event-stream.md\":\"LHmIwIcL\",\"front_interview_extends.md\":\"DL4vdflL\",\"front_interview_git-changyong.md\":\"CsKRUeVG\",\"front_interview_html5_newfeatures.md\":\"CvMda0i1\",\"front_interview_javascript-yunxingjizhi.md\":\"Bp5nDsB-\",\"front_interview_jsonp.md\":\"DOyzDtmX\",\"front_interview_kaifa-chongtu.md\":\"C0XnfXR8\",\"front_interview_keep-alive.md\":\"D5cQpLgc\",\"front_interview_key.md\":\"e01ZZCWW\",\"front_interview_layout-method.md\":\"CbVIEU2o\",\"front_interview_lese.md\":\"B9WUa0PE\",\"front_interview_let-const.md\":\"B0sldvx1\",\"front_interview_life-cycle.md\":\"Du9I2B5N\",\"front_interview_link.md\":\"CirFh8dQ\",\"front_interview_local-offline-storage.md\":\"Dr9kkOs9\",\"front_interview_method.md\":\"39jm3mG1\",\"front_interview_mvvm.md\":\"BjG3MarB\",\"front_interview_new-operator.md\":\"DzpSHMSf\",\"front_interview_nexttick.md\":\"D4fdbj4W\",\"front_interview_page-flashing.md\":\"wLW38UFu\",\"front_interview_promiss-lian.md\":\"BMLgd-fV\",\"front_interview_promiss.md\":\"Uqt9fgbx\",\"front_interview_prototypeand-prototype-chain.md\":\"BvRPkpRW\",\"front_interview_pseudo-class.md\":\"CZSpI8A4\",\"front_interview_route-hook-function.md\":\"CmF8bAMW\",\"front_interview_route.md\":\"Cg12lYBk\",\"front_interview_scope.md\":\"DO1WJDSS\",\"front_interview_style-isolation.md\":\"X7BvS5px\",\"front_interview_this.md\":\"fkDzh3eK\",\"front_interview_transfer-type.md\":\"IdZ1hPB7\",\"front_interview_two-way-binding.md\":\"BM2jHM7-\",\"front_interview_typeof.md\":\"tgKUKzKM\",\"front_interview_v-for-v-if.md\":\"BTz7oapT\",\"front_interview_v-ifandv-show.md\":\"BWgtYqmA\",\"front_interview_v-on.md\":\"QtK_p9U7\",\"front_interview_vue-core-concepts.md\":\"qscHMR8I\",\"front_interview_vue-modifiers.md\":\"CAp26lag\",\"front_interview_vue-react.md\":\"DxC4dQ2h\",\"front_interview_vue-route-vs-router.md\":\"BStCBdqY\",\"front_interview_vue2-vue3.md\":\"nF7rYFgf\",\"front_interview_vuex.md\":\"C6pVmNKs\",\"front_interview_website-performance.md\":\"DQmzf9LD\",\"front_mini_app_index.md\":\"C8xweTZK\",\"front_mini_hb2cli_index.md\":\"CHn4ePq9\",\"front_mini_packagesize_index.md\":\"C0enUNUX\",\"front_mini_publish_index.md\":\"Bc6JIr_i\",\"front_mini_thirdsdk_index.md\":\"iBj818-c\",\"front_mini_trap_index.md\":\"DMWtXhqy\",\"front_mini_var_index.md\":\"D018miMK\",\"front_practice_blog_index.md\":\"DrmTkhSZ\",\"front_source_react_hooks_index.md\":\"CpZ_5wBv\",\"front_source_vue2_reactive_index.md\":\"BdwNWjlU\",\"index.md\":\"D8Ol0Wqz\",\"javascript_index.md\":\"g13C9ZAq\",\"markdown_components_daima.md\":\"pt0eNGJ7\",\"markdown_components_emoji.md\":\"D9zLh0ip\",\"markdown_components_mulu.md\":\"BwouEPXV\",\"markdown_components_rongqi.md\":\"B4esUgIx\",\"markdown_components_table.md\":\"D-MOGm8N\",\"markdown_components_ziti.md\":\"CCDLGTyk\",\"markdown_components_zujian.md\":\"D4mOhrQm\",\"markdown_index.md\":\"Dt0SfUyL\",\"meinv_hufu.md\":\"D9zjp-8Q\",\"meinv_hufu1.md\":\"DXJk1MHF\",\"others_maintain_cache_index.md\":\"D9eqHxpj\",\"others_maintain_docker_index.md\":\"BNSbq7d7\",\"others_maintain_jenkins_index.md\":\"BnbNEiQe\",\"others_maintain_ng_index.md\":\"C8WvAod3\",\"others_operation_git_index.md\":\"C-jncxwg\",\"others_operation_linux_index.md\":\"BUXnzZoT\",\"others_operation_md_index.md\":\"CqAbmcX8\",\"others_target_index.md\":\"uHmzgbVs\",\"python_basic.md\":\"CnmKEOCN\",\"python_class.md\":\"CvU95mGj\",\"python_error.md\":\"C7NIeU1o\",\"python_function.md\":\"CyZl7Oep\",\"python_student.md\":\"DmQ_l8gJ\",\"python_toolbox.md\":\"C2-M6QWd\",\"python_toollibrary.md\":\"0VK6Jsm_\",\"python_with.md\":\"Cr9d6mzJ\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"星辰小站\",\"description\":\"A VitePress site\",\"base\":\"/vitePress/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"首页\",\"link\":\"/\"},{\"text\":\"宝宝\",\"link\":\"/meinv/hufu\",\"activeMatch\":\"/hufu/\"},{\"text\":\"Markdown\",\"link\":\"/Markdown\"},{\"text\":\"演示\",\"link\":\"/api/label\"},{\"text\":\"SwyUI 组件库\",\"link\":\"/component\"},{\"text\":\"TocoUI 组件库\",\"link\":\"/component\"},{\"text\":\"前端\",\"link\":\"/front/engi/rule\",\"activeMatch\":\"/front/\"},{\"text\":\"javascript\",\"link\":\"/javascript\"},{\"text\":\"后端\",\"link\":\"/back/framework/chooseFrameWork\",\"activeMatch\":\"/back/\"},{\"text\":\"其他\",\"link\":\"/others/operation/git\",\"activeMatch\":\"/others/\"},{\"text\":\"Git 规范\",\"link\":\"/conventionalCommits/git\",\"activeMatch\":\"/conventionalCommits/\"},{\"text\":\"python\",\"link\":\"/python/basic\",\"activeMatch\":\"/python/\"},{\"text\":\"大模型\",\"link\":\"/AILargeModel/TechnicalTerm\",\"activeMatch\":\"/AILargeModel/\"}],\"sidebar\":{\"/meinv/\":[{\"text\":\"宝宝\",\"collapsible\":true,\"collapsed\":false,\"items\":[{\"text\":\"护肤\",\"collapsible\":true,\"collapsed\":false,\"link\":\"/meinv/hufu/\"},{\"text\":\"护肤1\",\"collapsible\":true,\"collapsed\":false,\"link\":\"/meinv/hufu1/\"}]}],\"/front/\":[{\"text\":\"前端面试题\",\"collapsible\":true,\"collapsed\":false,\"items\":[{\"text\":\"HTML5与CSS3\",\"collapsible\":true,\"collapsed\":false,\"items\":[{\"text\":\"HTML5 新特性\",\"link\":\"/front/interview/html5/newFeatures\"},{\"text\":\"CSS3 新特性\",\"link\":\"/front/interview/css3/newFeatures\"}]},{\"text\":\"CSS布局方式\",\"link\":\"/front/interview/layout-method\"},{\"text\":\"DIV居中\",\"link\":\"/front/interview/div-center\"},{\"text\":\"伪类与伪元素的区别\",\"link\":\"/front/interview/pseudo-class\"},{\"text\":\"css 选择器的优先级排序\",\"link\":\"/front/interview/css-priority\"},{\"text\":\"深拷贝与浅拷贝\",\"link\":\"/front/interview/copy\"},{\"text\":\"封装过的组件\",\"link\":\"/front/interview/encapsulated\"},{\"text\":\"JSONP原理\",\"link\":\"/front/interview/jsonp\"},{\"text\":\"本地离线存储\",\"link\":\"/front/interview/Local-offline-storage\"},{\"text\":\"LINK与A标签\",\"link\":\"/front/interview/link\"},{\"text\":\"盒子模型\",\"link\":\"/front/interview/box-model\"},{\"text\":\"闭包\",\"link\":\"/front/interview/closure\"},{\"text\":\"作用域\",\"link\":\"/front/interview/scope\"},{\"text\":\"网站性能优化\",\"link\":\"/front/interview/website-performance\"},{\"text\":\"ES5 与 ES6新特性\",\"link\":\"/front/interview/es6\"},{\"text\":\"对于MVVM的理解\",\"link\":\"/front/interview/mvvm\"},{\"text\":\"Vue生命周期\",\"link\":\"/front/interview/life-cycle\"},{\"text\":\"Vue数据双向绑定\",\"link\":\"/front/interview/two-way-binding\"},{\"text\":\"组件间传值\",\"link\":\"/front/interview/component-value-transfer\"},{\"text\":\"Vue路由\",\"link\":\"/front/interview/route\"},{\"text\":\"Vue路由钩子函数\",\"link\":\"/front/interview/route-hook-function\"},{\"text\":\"Vue数据管理中心\",\"link\":\"/front/interview/vuex\"},{\"text\":\"keep-alive\",\"link\":\"/front/interview/keep-alive\"},{\"text\":\"css样式隔离\",\"link\":\"/front/interview/style-isolation\"},{\"text\":\"v-if 和 v-show\",\"link\":\"/front/interview/v-ifANDv-show\"},{\"text\":\"vue-route 和 vue-router\",\"link\":\"/front/interview/vue-route-vs-router\"},{\"text\":\"vue核心概念\",\"link\":\"/front/interview/vue-core-concepts\"},{\"text\":\"v-for 和 v-if\",\"link\":\"/front/interview/v-for-v-if\"},{\"text\":\"Vue修饰符\",\"link\":\"/front/interview/vue-modifiers\"},{\"text\":\"vue中的跨域问题\",\"link\":\"/front/interview/cross-domain\"},{\"text\":\"浏览器与服务器的交互原理\",\"link\":\"/front/interview/browser-server-interaction\"},{\"text\":\"v-on 可以绑定多个方法吗\",\"link\":\"/front/interview/v-on\"},{\"text\":\"vue中key 值的作用\",\"link\":\"/front/interview/key\"},{\"text\":\"$nextTick的使用\",\"link\":\"/front/interview/nextTick\"},{\"text\":\"父组件调用子组件方法\",\"link\":\"/front/interview/method\"},{\"text\":\"项目初始化页面闪动问题\",\"link\":\"/front/interview/page-flashing\"},{\"text\":\"vue2 与vue3 的区别\",\"link\":\"/front/interview/vue2-vue3\"},{\"text\":\"vue和react的区别\",\"link\":\"/front/interview/vue-react\"},{\"text\":\"js数组的方法\",\"link\":\"/front/interview/arrary\"},{\"text\":\"监听 DOM 树\",\"link\":\"/front/interview/DOM-tree\"},{\"text\":\"JavaScript 的事件循环机制\",\"link\":\"/front/interview/event-cycle-mechanism\"},{\"text\":\"Javascript的数据类型\",\"link\":\"/front/interview/data-type\"},{\"text\":\"怎样判断变量的类型\",\"link\":\"/front/interview/typeof\"},{\"text\":\"数据类型转换\",\"link\":\"/front/interview/transfer-type\"},{\"text\":\"原型和原型链\",\"link\":\"/front/interview/prototypeand-prototype-chain\"},{\"text\":\"call /apply /bind\",\"link\":\"/front/interview/call-apply-bind\"},{\"text\":\"DOM 事件流和事件委托详解\",\"link\":\"/front/interview/event-stream\"},{\"text\":\"new 操作符内部原理详解\",\"link\":\"/front/interview/new-operator\"},{\"text\":\"防抖、节流的应用场景\",\"link\":\"/front/interview/Anti-vibration-throttling\"},{\"text\":\"this指向\",\"link\":\"/front/interview/this\"},{\"text\":\"let const var 的区别\",\"link\":\"/front/interview/let-const\"},{\"text\":\"Promise 的理解\",\"link\":\"/front/interview/promiss\"},{\"text\":\"Promise 为什么支持链式调用\",\"link\":\"/front/interview/promiss-lian\"},{\"text\":\"Javascript的运行机制\",\"link\":\"/front/interview/javascript-yunxingjizhi\"},{\"text\":\"实现继承的几种方式\",\"link\":\"/front/interview/extends\"},{\"text\":\"浏览器垃圾回收\",\"link\":\"/front/interview/lese\"},{\"text\":\"多人开发 避免版本冲突\",\"link\":\"/front/interview/kaifa-chongtu\"},{\"text\":\"Git 常用命令\",\"link\":\"/front/interview/git-changyong\"}]},{\"text\":\"前端工程化\",\"collapsible\":true,\"collapsed\":false,\"items\":[{\"text\":\"前端规范搭建\",\"link\":\"/front/engi/rule/\"},{\"text\":\"Monorepo理论与实践\",\"link\":\"/front/engi/monorepo/\"},{\"text\":\"前端常见性能优化方案\",\"link\":\"/front/base/performance/\"},{\"text\":\"前端资源部署策略\",\"link\":\"/front/engi/deploy/\"},{\"text\":\"微前端架构浅析\",\"link\":\"/front/engi/microFront/\"},{\"text\":\"前端视角看CICD\",\"link\":\"/front/engi/CICD/\"}]},{\"text\":\"前端基础\",\"collapsible\":true,\"collapsed\":false,\"items\":[{\"text\":\"前端最全Debugger技巧\",\"link\":\"/front/base/debugger/\"},{\"text\":\"从前端视角看AI世界\",\"link\":\"/front/base/Ai/\"},{\"text\":\"Vue2源码之响应式及队列调度\",\"link\":\"/front/source/vue2/reactive/\"},{\"text\":\"TS入门及实践\",\"link\":\"/front/base/TS/\"},{\"text\":\"前端常用设计模式\",\"link\":\"/front/base/designMode/\"},{\"text\":\"Redux入门及实践\",\"link\":\"/front/base/react/redux/\"},{\"text\":\"10分钟搭建一个属于自己的博客\",\"link\":\"/front/practice/blog/\"},{\"text\":\"做过的算法题合集\",\"link\":\"/front/base/algorithm/\"}]},{\"text\":\"Uniapp跨端开发\",\"collapsible\":true,\"collapsed\":false,\"items\":[{\"text\":\"包体积优化\",\"link\":\"/front/mini/packageSize/\"},{\"text\":\"自定义编译变量及环境变量\",\"link\":\"/front/mini/var/\"},{\"text\":\"Uniapp对接微信原生SDK\",\"link\":\"/front/mini/thirdSDK/\"},{\"text\":\"Uniapp开发App入门与实践\",\"link\":\"/front/mini/app/\"},{\"text\":\"App上架各应用市场攻略\",\"link\":\"/front/mini/publish\"}]}],\"/back/\":[{\"text\":\"后端基础\",\"items\":[{\"text\":\"论全干工程师的自我修养\",\"link\":\"/back/framework/chooseFrameWork/\"},{\"text\":\"浅析后端三层架构\",\"link\":\"/back/framework/structure/\"},{\"text\":\"Nest入门与实践\",\"link\":\"/back/framework/nest/\"},{\"text\":\"Redis入门与实践\",\"link\":\"/back/framework/redis/\"},{\"text\":\"关系型数据与非关系型数据库\",\"link\":\"/back/framework/database\"},{\"text\":\"MySql入门与实践\",\"link\":\"/back/framework/mysql\"}]}],\"/others\":[{\"text\":\"常用操作指令\",\"items\":[{\"text\":\"Git\",\"link\":\"/others/operation/git/\"},{\"text\":\"MarkDown\",\"link\":\"/others/operation/md/\"},{\"text\":\"Linux\",\"link\":\"/others/operation/linux/\"}]},{\"text\":\"网络与运维\",\"items\":[{\"text\":\"Nginx\",\"link\":\"/others/maintain/ng/\"},{\"text\":\"Docker\",\"link\":\"/others/maintain/docker/\"},{\"text\":\"Jenkins\",\"link\":\"/others/maintain/jenkins/\"},{\"text\":\"浅析浏览器缓存\",\"link\":\"/others/maintain/cache/\"}]}],\"/Markdown\":[{\"text\":\"Markdown 语法\",\"items\":[{\"text\":\"表格\",\"link\":\"/Markdown/components/table\"},{\"text\":\"目录\",\"link\":\"/Markdown/components/mulu\"},{\"text\":\"容器\",\"link\":\"/Markdown/components/rongqi\"},{\"text\":\"字体样式\",\"link\":\"/Markdown/components/ziti\"},{\"text\":\"支持的表情\",\"link\":\"/Markdown/components/emoji\"},{\"text\":\"代码块\",\"link\":\"/Markdown/components/daima\"},{\"text\":\"组件\",\"link\":\"/Markdown/components/zujian\"}]}],\"/api\":[{\"text\":\"组建的演示方法\",\"items\":[{\"text\":\"使用标签的写法\",\"link\":\"/api/label\"},{\"text\":\"使用相对路径的写法\",\"link\":\"/api/path\"},{\"text\":\"注册方法\",\"link\":\"/api/functions\"}]}],\"/component\":[{\"text\":\"SwyUI 组件库\",\"collapsible\":true,\"collapsed\":true,\"items\":[{\"text\":\"基础组件\",\"collapsible\":true,\"collapsed\":true,\"items\":[{\"text\":\"button\",\"link\":\"/component/swy-ui/jichu/button\"}]}]},{\"text\":\"TocoUI 组件库\",\"collapsible\":true,\"collapsed\":true,\"items\":[{\"text\":\"ProField 原子组件\",\"collapsible\":true,\"collapsed\":true,\"items\":[{\"text\":\"text\",\"link\":\"/component/toco-ui/proField/text\"},{\"text\":\"autocomplete\",\"link\":\"/component/toco-ui/proField/autocomplete\"},{\"text\":\"inputNumber\",\"link\":\"/component/toco-ui/proField/inputNumber\"},{\"text\":\"select\",\"link\":\"/component/toco-ui/proField/select\"},{\"text\":\"checkbox\",\"link\":\"/component/toco-ui/proField/checkbox\"},{\"text\":\"price\",\"link\":\"/component/toco-ui/proField/price\"},{\"text\":\"radio\",\"link\":\"/component/toco-ui/proField/radio\"},{\"text\":\"rate\",\"link\":\"/component/toco-ui/proField/rate\"},{\"text\":\"slider\",\"link\":\"/component/toco-ui/proField/slider\"},{\"text\":\"switch\",\"link\":\"/component/toco-ui/proField/switch\"},{\"text\":\"avatar\",\"link\":\"/component/toco-ui/proField/avatar\"},{\"text\":\"image\",\"link\":\"/component/toco-ui/proField/image\"},{\"text\":\"cascader\",\"link\":\"/component/toco-ui/proField/cascader\"},{\"text\":\"colorPicker\",\"link\":\"/component/toco-ui/proField/colorPicker\"},{\"text\":\"segmented\",\"link\":\"/component/toco-ui/proField/segmented\"},{\"text\":\"divider\",\"link\":\"/component/toco-ui/proField/divider\"},{\"text\":\"inputTag\",\"link\":\"/component/toco-ui/proField/inputTag\"},{\"text\":\"mention\",\"link\":\"/component/toco-ui/proField/mention\"},{\"text\":\"selectV2\",\"link\":\"/component/toco-ui/proField/selectV2\"},{\"text\":\"timePicker\",\"link\":\"/component/toco-ui/proField/timePicker\"},{\"text\":\"timeSelect\",\"link\":\"/component/toco-ui/proField/timeSelect\"},{\"text\":\"transfer\",\"link\":\"/component/toco-ui/proField/transfer\"},{\"text\":\"treeSelect\",\"link\":\"/component/toco-ui/proField/treeSelect\"},{\"text\":\"upload\",\"link\":\"/component/toco-ui/proField/upload\"},{\"text\":\"button\",\"link\":\"/component/toco-ui/proField/button\"},{\"text\":\"datePicker\",\"link\":\"/component/toco-ui/proField/datePicker\"}]},{\"text\":\"ProFormField 表单原子组件\",\"collapsible\":true,\"collapsed\":true,\"items\":[{\"text\":\"text\",\"link\":\"/component/toco-ui/ProFormField/text\"},{\"text\":\"autocomplete\",\"link\":\"/component/toco-ui/ProFormField/autocomplete\"},{\"text\":\"inputNumber\",\"link\":\"/component/toco-ui/ProFormField/inputNumber\"},{\"text\":\"select\",\"link\":\"/component/toco-ui/ProFormField/select\"},{\"text\":\"checkbox\",\"link\":\"/component/toco-ui/ProFormField/checkbox\"},{\"text\":\"radio\",\"link\":\"/component/toco-ui/ProFormField/radio\"},{\"text\":\"rate\",\"link\":\"/component/toco-ui/ProFormField/rate\"},{\"text\":\"slider\",\"link\":\"/component/toco-ui/ProFormField/slider\"},{\"text\":\"switch\",\"link\":\"/component/toco-ui/ProFormField/switch\"},{\"text\":\"avatar\",\"link\":\"/component/toco-ui/ProFormField/avatar\"},{\"text\":\"image\",\"link\":\"/component/toco-ui/ProFormField/image\"},{\"text\":\"cascader\",\"link\":\"/component/toco-ui/ProFormField/cascader\"},{\"text\":\"colorPicker\",\"link\":\"/component/toco-ui/ProFormField/colorPicker\"},{\"text\":\"segmented\",\"link\":\"/component/toco-ui/ProFormField/segmented\"},{\"text\":\"divider\",\"link\":\"/component/toco-ui/ProFormField/divider\"},{\"text\":\"inputTag\",\"link\":\"/component/toco-ui/ProFormField/inputTag\"},{\"text\":\"mention\",\"link\":\"/component/toco-ui/ProFormField/mention\"},{\"text\":\"selectV2\",\"link\":\"/component/toco-ui/ProFormField/selectV2\"},{\"text\":\"timePicker\",\"link\":\"/component/toco-ui/ProFormField/timePicker\"},{\"text\":\"timeSelect\",\"link\":\"/component/toco-ui/ProFormField/timeSelect\"},{\"text\":\"transfer\",\"link\":\"/component/toco-ui/ProFormField/transfer\"},{\"text\":\"treeSelect\",\"link\":\"/component/toco-ui/ProFormField/treeSelect\"},{\"text\":\"button\",\"link\":\"/component/toco-ui/ProFormField/button\"},{\"text\":\"datePicker\",\"link\":\"/component/toco-ui/ProFormField/datePicker\"}]},{\"text\":\"ProForm 表单组件\",\"collapsible\":true,\"collapsed\":true,\"items\":[{\"text\":\"基础用法\",\"link\":\"/component/toco-ui/proForm/basic\"},{\"text\":\"组件间的联动\",\"link\":\"/component/toco-ui/proForm/effects\"},{\"text\":\"ModalForm 弹窗表单组件\",\"link\":\"/component/toco-ui/ModalForm/index\"},{\"text\":\"DrawerForm 抽屉表单组件\",\"link\":\"/component/toco-ui/DrawerForm/index\"},{\"text\":\"ProInputTag 暂存历史记录\",\"link\":\"/component/toco-ui/ProInputTag/index\"}]},{\"text\":\"ProSelect 组件\",\"collapsible\":true,\"collapsed\":true,\"items\":[{\"text\":\"基础用法\",\"link\":\"/component/toco-ui/ProSelect/basic\"},{\"text\":\"瀑布流\",\"link\":\"/component/toco-ui/ProSelect/waterfall\"},{\"text\":\"表格\",\"link\":\"/component/toco-ui/ProSelect/table\"}]},{\"text\":\"ProTable 组件\",\"collapsible\":true,\"collapsed\":true,\"items\":[{\"text\":\"basic\",\"link\":\"/component/toco-ui/ProTable/basic\"},{\"text\":\"toolbar\",\"link\":\"/component/toco-ui/ProTable/toolbar\"},{\"text\":\"toolbar-buttons\",\"link\":\"/component/toco-ui/ProTable/toolbar-buttons\"},{\"text\":\"toolbar-filters\",\"link\":\"/component/toco-ui/ProTable/toolbar-filters\"},{\"text\":\"toolbar-search\",\"link\":\"/component/toco-ui/ProTable/toolbar-search\"},{\"text\":\"export\",\"link\":\"/component/toco-ui/ProTable/export\"},{\"text\":\"import\",\"link\":\"/component/toco-ui/ProTable/import\"},{\"text\":\"editable-only\",\"link\":\"/component/toco-ui/ProTable/editable-only\"},{\"text\":\"editable-cell\",\"link\":\"/component/toco-ui/ProTable/editable-cell\"},{\"text\":\"editable-single\",\"link\":\"/component/toco-ui/ProTable/editable-single\"},{\"text\":\"editable-multiple\",\"link\":\"/component/toco-ui/ProTable/editable-multiple\"},{\"text\":\"table-ref\",\"link\":\"/component/toco-ui/ProTable/table-ref\"}]}]}],\"/AILargeModel\":[{\"text\":\"AI大模型基本原理及API使用\",\"collapsible\":true,\"collapsed\":true,\"link\":\"/AILargeModel/jibenyuanli\"},{\"text\":\"RAG 大模型\",\"collapsible\":true,\"collapsed\":true,\"link\":\"/AILargeModel/RAG\"},{\"text\":\"Embedding 模型\",\"collapsible\":true,\"collapsed\":true,\"link\":\"/AILargeModel/Embedding\"}],\"/python\":[{\"text\":\"基础语法结构\",\"collapsible\":true,\"collapsed\":true,\"link\":\"/python/basic\"},{\"text\":\"面向对象编程\",\"collapsible\":true,\"collapsed\":true,\"link\":\"/python/class\"},{\"text\":\"异常处理\",\"collapsible\":true,\"collapsed\":true,\"link\":\"/python/error\"},{\"text\":\"函数定义与使用\",\"collapsible\":true,\"collapsed\":true,\"link\":\"/python/function\"},{\"text\":\"上下文管理（with语句）\",\"collapsible\":true,\"collapsed\":true,\"link\":\"/python/with\"},{\"text\":\"Python 核心工具箱\",\"collapsible\":true,\"collapsed\":true,\"link\":\"/python/toolbox\"},{\"text\":\"Python 实用工具库\",\"collapsible\":true,\"collapsed\":true,\"link\":\"/python/toollibrary\"},{\"text\":\"学习路径建议\",\"collapsible\":true,\"collapsed\":true,\"link\":\"/python/student\"}]},\"carbonAds\":{\"code\":\"CEBDT27Y\",\"placement\":\"vuejsorg\"},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/vuejs/\"},{\"icon\":\"twitter\",\"link\":\"https://twitter.com/vuejs\"},{\"icon\":\"discord\",\"link\":\"https://discord.com/invite/vue\"}]},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>