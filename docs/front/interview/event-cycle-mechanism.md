# js的事件循环机制

**JavaScript 的事件循环就是一个“待办事项清单”处理机制，它永远会先处理完手头最急、最确定的事情（同步任务），然后才不断地去查看并处理那些不确定什么时候完成的事情（异步任务）。**

## 1. 基本概念：单线程与异步

- 单线程：JavaScript 是单线程的，就像厨房只有一个厨师。他一次只能做一道菜。如果有一道菜特别耗时，后面的顾客就得一直等着，这显然不行。
- 异步：为了解决这个问题，厨房（浏览器/Node.js）提供了一些帮手（Web APIs / C++ APIs）。当厨师遇到需要等待的任务（比如炖汤、等外卖），他就把这个任务交给帮手去做，自己则继续做后面的菜

## 2. 核心组成部分（厨房的三个区域）

事件循环机制依赖于三个关键部分：

1. **调用栈：厨师当前的工作台。** 他正在处理的菜谱步骤（执行上下文）会一层层叠放在这里。执行完一步，就把它从栈顶拿走。
2. **任务队列：** 一个“待完成菜品”的队列。帮手们（如 setTimeout, AJAX, 事件监听) 完成的任务，会把他们对应的回调函数放在这个队列里排队，等待调用栈空闲时被执行。

- 注意：实际上有多个队列，优先级不同，下面会细说。

3. **事件循环：** 这位是餐厅经理。他的工作非常简单且重复：

- 不断检查调用栈是否为空。
- 一旦调用栈空了，他就去任务队列里看看，有没有在排队等待的回调函数。
- 如果有，就把队列里的第一个回调函数拿出来，放到调用栈中去执行。

## 3. 宏任务 vs 微任务（任务的优先级）

- 宏任务：可以理解为“大任务”或“新订单”。

1. **包含：** `setTimeout`, `setInterval`, `setImmediate (Node.js)`, `I/O操作`, `UI渲染`, `requestAnimationFrame`。
2. **特点：** 每次事件循环只取一个宏任务来执行。

- 微任务：可以理解为“小任务”或“临时加急单”，优先级比宏任务高。

1. **包含：** `Promise.then()`, `Promise.catch()`, `Promise.finally()`, `async/await`（本质是Promise）, `process.nextTick` (Node.js，优先级最高), `MutationObserver`。
2. **特点：** 只要调用栈一空，事件循环会清空整个微任务队列里的所有任务，然后才会去取下一个宏任务。

## 4. 完整事件循环流程（厨师的工作流）

1. **执行全局脚本**（同步代码）：这算是第一个宏任务。厨师开始按照第一张订单（主程序）做菜。
2. **遇到异步代码：**

- 如果是 `setTimeout`，厨师就把它交给“定时器帮手”，然后继续做菜。时间到了，帮手会把回调函数放到**宏任务队列** 。
- 如果是 `Promise.then()`，厨师就把它交给“Promise帮手”，当Promise状态变为fulfilled或rejected后，帮手会把回调函数放到**微任务队列**。

3. **同步代码执行完毕：** 调用栈变空了。
4. **经理（事件循环）开始工作：**

- 经理**首先**去检查**微任务队列**。
- 如果微任务队列里有任务，经理会**一次性、全部**把它们拿出来，按顺序放到调用栈中执行。
- **关键点：** 在执行当前微任务的过程中，如果又产生了新的微任务，经理会继续清空新的微任务队列，直到微任务队列完全为空为止。这可能会导致宏任务被“饿死”。

5. **微任务清空后：** 经理再去**宏任务队列**里，取出**第一个**宏任务（比如那个setTimeout的回调），放到调用栈中执行。
6. **重复：** 执行这个宏任务（这又开启了一个新的执行上下文），回到第2步。如此循环往复。

## 题目：请问以下代码的输出顺序是什么？

```javascript
console.log('1');

setTimeout(function () {
  console.log('2');
  new Promise(function (resolve) {
    console.log('3');
    resolve();
  }).then(function () {
    console.log('4');
  });
}, 0);

new Promise(function (resolve) {
  console.log('5');
  resolve();
}).then(function () {
  console.log('6');
});

console.log('7');
```

## 面试回答技巧总结

```text
1.先给一句精炼的总结：“事件循环是JS处理异步任务的机制，它保证单线程不阻塞。”

2.引入比喻：使用“厨师与餐厅厨房”或“经理与待办清单”的比喻，让概念更生动。

3.明确核心部件：清晰地指出“调用栈”、“任务队列”、“事件循环”各自的作用。

4.重点区分宏微任务：这是考察的重点。一定要强调 “微任务的优先级高于宏任务，且会在当前宏任务结束后立即清空”。

5.结合实例：如果面试官允许，可以画一个简单的流程图，或者用上面那道例题来佐证你的说法。
```
